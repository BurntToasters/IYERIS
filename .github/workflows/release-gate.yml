name: Release Gate

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * 1'

permissions:
  contents: read

env:
  NODE_VERSION: '24'
  CSC_IDENTITY_AUTO_DISCOVERY: 'false'
  HUSKY: '0'

jobs:
  windows-release-gate:
    name: Windows Targets (NSIS/MSI/MS Store)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Dependency preflight
        run: npm run deps:preflight

      - name: Build
        run: npm run build

      - name: Ensure license manifest exists
        run: node -e "const fs=require('fs');if(!fs.existsSync('licenses.json'))fs.writeFileSync('licenses.json','[]\\n');"

      - name: Package NSIS (x64)
        run: npx electron-builder --win nsis --x64 --publish never

      - name: Package MSI (x64)
        run: npx electron-builder --win msi --x64 --publish never

      - name: Package Microsoft Store (x64)
        run: npx electron-builder --win --x64 -c electron-builder.msstore.yml --publish never

  macos-release-gate:
    name: macOS Targets (DMG/ZIP)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Dependency preflight
        run: npm run deps:preflight

      - name: Build
        run: npm run build

      - name: Ensure license manifest exists
        run: node -e "const fs=require('fs');if(!fs.existsSync('licenses.json'))fs.writeFileSync('licenses.json','[]\\n');"

      - name: Package DMG + ZIP (universal)
        run: npx electron-builder --mac dmg zip --universal --publish never

  linux-release-gate:
    name: Linux Targets (AppImage/DEB/RPM/Flatpak)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Dependency preflight
        run: npm run deps:preflight

      - name: Build
        run: npm run build

      - name: Ensure license manifest exists
        run: node -e "const fs=require('fs');if(!fs.existsSync('licenses.json'))fs.writeFileSync('licenses.json','[]\\n');"

      - name: Package AppImage + DEB + RPM (x64)
        run: npx electron-builder --linux AppImage deb rpm --x64 --publish never

      - name: Install Flatpak toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder

      - name: Install Flatpak runtimes
        run: |
          flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak install -y flathub org.freedesktop.Platform//24.08
          flatpak install -y flathub org.freedesktop.Sdk//24.08
          flatpak install -y flathub org.electronjs.Electron2.BaseApp//24.08
          flatpak install -y flathub org.freedesktop.Sdk.Extension.node22//24.08

      - name: Package Flatpak (x64)
        run: npm run flatpak:bundle:x64
